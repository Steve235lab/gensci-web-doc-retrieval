# 搜索

**王义成 2022/6/14**

---

## 1. 前端向后端发送用户输入的关键词

* 用户在输入框中输入要搜索的关键词

* 起止时间选择

* 筛选器复选框

* 实验物种选择

* 然后点击搜索按钮

* 前端 -> 后端

    url: 42.192.44.52:8000/search/

    ```
    {
        "token": token,
        "message_type": "search", 
        "keywords": ..., 
        "start_time": ..., 
        "end_time": ..., 
        "article_type": [...],
        "language": [...],
        "species": [...],
        "sex": [...],
        "age": [...]
    }
    ```

    > token示例：eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1dWlkIjoiMDAxIiwiZXhwIjoxNjU1NDUzMzg2LjEyODI2LCJzYWx0IjoiU3RldmUyMzVMYWIifQ.vLmc5nNmJc4xBN83CMneKEYG2GmIDan-p_fP91n7WTE

* 后端 -> 前端（响应消息）
    
    ```
    {   
        'message_type': 'search_received',
        'token': token
    }
    ```

## 2. 后端对关键词做鲁棒性处理

* 示例如下：
    > (Alzheimer disease) AND (α-synuclein)

    > (Cardiovascular disease) AND (sST2)

    > ("bacterial") AND ("extracellular vesicles") AND "has abstract"[Filters] AND "english"[Language]

    > (microbiome OR microbiota OR microbe) AND (has abstract[FILT]) AND ("2000/01/01"[Date - Publication]:"3000"[Date - Publication])

    > (Dysphagia) AND (humans[FILT]) AND (supplement OR supplementary) OR intake) AND ((meta-analysis[FILT]) OR (randomized controlled trial[FILT]) OR (systematic review[FILT]) OR (clinical trial[FILT])) AND (has abstract[FILT])

## 3. 后端启动搜索服务，并将关键词组合关联至用户

* 获取当前时间戳 ```timestamp```，即开始搜索时刻的时间戳

* 将关键词组合添加至 ```User.search_history``` 中，即向用户对象的字典成员 ```search_history``` 中添加一个新的键值对，用 ```timestamp``` 作为键，值暂时设为 ```[keywords, False]``` ， 其中 ```keywords``` 为字符串类型的鲁棒性处理后的搜索关键词，```False``` 为布尔值表示搜索尚未完成

    ```python
    User.search_history[timestamp] = [keywords, False]
    ```

* 到 ```static/uuid/result/``` 下新建文件夹 ```timestamp```，用来保存结果

## 4. 搜索完成，后端保存结果，向用户邮箱发送提醒邮件

* 将两个Excel表格保存到 ```static/uuid/result/timestamp/``` 

* 将搜索完成标志位 ```User.search_history[timestamp][1]``` 置为 ```True```

    ```python
    User.search_history[timestamp][1] = True
    ```

* 使用SMTP向用户发送提醒邮件

## 5. 前端请求用户的历史记录

* 前端 -> 后端

    url: 42.192.44.52:8000/search/history/

    ```
    {
        'message_type': 'get_history',
        'token': token
    }
    ```

* 后端 -> 前端

    将用户的搜索历史记录用Json格式发送到前端

    ```
    {   
        'message_type': 'history_list',
        'history': {
            timestamp_0: {
                raw_keywords: keywords_0,
                robust_keywords: robust_keywords0
            },
            timestamp_1: {
                raw_keywords: keywords_1,
                robust_keywords: robust_keywords1
            },
            ...
        },
        'token': token
    }
    ```

    > 注意，这里返回的是最后n条搜索记录，n由后台参数确定，当前 n = 100

* 前端将Json解包后生成元素并显示

## 6. 用户查看结果，前端向后端请求数据

* 用户点击历史记录中的某一条目(默认展示paper_info)

* 前端 -> 后端
    
    url: 42.192.44.52:8000/search/paper_info/

    ```
    {
        'token': token,
        'message_type': 'get_paper_info',
        'timestamp': timestamp,
        'page_num': page_num
    }
    ```

    > 其中 ```timestamp``` 为用户点击的历史记录的时间戳，是 ```history_list``` 中的时间戳

    > ```page_num``` 为当前页号，默认为1，每页显示n篇paper，n由后台参数确定，当前 n = 20


* 用户点击不同标签页切换结果显示(paper_info/clue_info/network)
* 前端 -> 后端

  url: 42.192.44.52:8000/search/clue_info/

    ```
    {
        'token': token,
        'message_type': 'get_clue_info',
        'timestamp': timestamp,
        'page_num': page_num
    }
    ```
  > 其中 ```timestamp``` 为用户点击的历史记录的时间戳，是 ```history_list``` 中的时间戳

  > ```page_num``` 为当前页号，默认为1，每页显示n篇paper，n由后台参数确定，当前 n = 20
  
  >点击```network```标签时，```page_num```为0，返回clue_info所有数据，用于绘图


* 用户点击clue_info/network页面中的Pmid,查看该文献详情

* 前端 -> 后端

  url: 42.192.44.52:8000/search/paper_details/

    ```
    {
        'token': token,
        'message_type': 'get_paper_details',
        'timestamp': timestamp,
        'pmid': pmid
    }
    ```

  > 其中 ```timestamp``` 为该文章所在搜索记录的时间戳

  > ```pmid``` 为用户所需查看文章的Pmid


## 7. 后端向前端发送Json数据包，前端解包并显示

* 后端 -> 前端
    
    将搜索结果用Json格式发送到前端
* paper_info

    ```
    {   
        'message_type': 'paper_result',
        'result_timestamp': result_timestamp,
        'paper_info': [paper_0, paper_1, ...],
        'total': total,
        'token': token
    }
    ```
    >```total```为paper_info总条数，用于前端生成总页码数

    > ```result_timestamp``` 可用于拼接结果文件的下载地址，结果文件存放于 ```/static/search_result/result_timestamp/``` 

    > 其中 ```paper_0```、```paper_1``` 均为json，其键值请参考 ```paper_info.xlsx```

* clue_info

    ```
    {   
        'message_type': 'clue_result',
        'result_timestamp': result_timestamp,
        'clue_info': [clue_0, clue_1, ...],
        'total': total,
        'token': token
    }
    ```
  >```total```为paper_info总条数，用于前端生成总页码数

  > ```result_timestamp``` 可用于拼接结果文件的下载地址，结果文件存放于 ```/static/search_result/result_timestamp/```

  > 其中 ```clue_0```、```clue_1``` 均为json，其键值请参考 ```clue_info.xlsx```

* network

   ```
    {   
        'message_type': 'network',
        'result_timestamp': result_timestamp,
        'clue_info': [clue_0, clue_1, ...],
        'token': token,
        'edge_type_list': [edge_type1,edge_type2,...]
    }
    ```

  >```edge_type_list```为所有边类型的集合，用于前端生成network选择框

  > 其中 ```clue_0```、```clue_1``` 均为json，其键值请参考 ```clue_info.xlsx```

* paper_details

    ```
    {   
        'message_type': 'paper_details',
        'paper_info': paper,
        'token': token
    }
    ```

  > 其中 ```paper```为json,格式同paper_info中单条paper

