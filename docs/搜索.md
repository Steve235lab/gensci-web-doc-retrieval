# 搜索

**王义成 2022/6/14**

---

## 1. 前端向后端发送用户输入的关键词

* 用户在输入框中输入要搜索的关键词

* 起止时间选择

* 筛选器复选框

* 实验物种选择

* 然后点击搜索按钮

* 前端 -> 后端

    url: 42.192.44.52:8000/search/

    ```
    {
        'token': token
        'message_type': 'search', 
        'keywords': ..., 
        'start_time': ..., 
        'end_time': ..., 
        'filters': [...], 
        'species': 'humans'/'other animals'
    }
    ```

    > token示例：eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1dWlkIjoiMDAxIiwiZXhwIjoxNjU1NDUzMzg2LjEyODI2LCJzYWx0IjoiU3RldmUyMzVMYWIifQ.vLmc5nNmJc4xBN83CMneKEYG2GmIDan-p_fP91n7WTE

* 后端 -> 前端（响应消息）
    
    ```
    {   
        'message_type': 'search_received',
        'token': token
    }
    ```

## 2. 后端对关键词做鲁棒性处理

* 示例如下：
    > (Alzheimer disease) AND (α-synuclein)

    > (Cardiovascular disease) AND (sST2)

    > ("bacterial") AND ("extracellular vesicles") AND "has abstract"[Filters] AND "english"[Language]

    > (microbiome OR microbiota OR microbe) AND (has abstract[FILT]) AND ("2000/01/01"[Date - Publication]:"3000"[Date - Publication])

    > (Dysphagia) AND (humans[FILT]) AND (supplement OR supplementary) OR intake) AND ((meta-analysis[FILT]) OR (randomized controlled trial[FILT]) OR (systematic review[FILT]) OR (clinical trial[FILT])) AND (has abstract[FILT])

## 3. 后端启动搜索服务，并将关键词组合关联至用户

* 获取当前时间戳 ```timestamp```，即开始搜索时刻的时间戳

* 将关键词组合添加至 ```User.search_history``` 中，即向用户对象的字典成员 ```search_history``` 中添加一个新的键值对，用 ```timestamp``` 作为键，值暂时设为 ```[keywords, False]``` ， 其中 ```keywords``` 为字符串类型的鲁棒性处理后的搜索关键词，```False``` 为布尔值表示搜索尚未完成

    ```python
    User.search_history[timestamp] = [keywords, False]
    ```

* 到 ```static/uuid/result/``` 下新建文件夹 ```timestamp```，用来保存结果

## 4. 搜索完成，后端保存结果，向用户邮箱发送提醒邮件

* 将两个Excel表格保存到 ```static/uuid/result/timestamp/``` 

* 将搜索完成标志位 ```User.search_history[timestamp][1]``` 置为 ```True```

    ```python
    User.search_history[timestamp][1] = True
    ```

* 使用SMTP向用户发送提醒邮件

## 5. 前端请求用户的历史记录

* 前端 -> 后端

    url: 42.192.44.52:8000/search/history/

    ```
    {
        'message_type': 'get_history',
        'token': token
    }
    ```

* 后端 -> 前端

    将用户的搜索历史记录用Json格式发送到前端

    ```
    {   
        'message_type': 'history_list',
        'history': {
            timestamp_0: keywords_0,
            timestamp_1: keywords_1,
            ...
        },
        'token': token
    }
    ```

* 前端将Json解包后生成元素并显示

## 6. 用户查看结果，前端向后端请求数据

* 用户点击历史记录中的某一条目

* 前端 -> 后端
    
    url: 42.192.44.52:8000/search/result/

    ```
    {
        'token': token,
        'message_type': 'get_result',
        'timestamp': timestamp,
        'page_num': page_num
    }
    ```

    > 其中 ```timestamp``` 为用户点击的历史记录的时间戳，是 ```history_list``` 中的时间戳

    > ```page_num``` 为当前页号，从1开始，如果为0则表示返回所有paper

## 7. 后端向前端发送Json数据包，前端解包并显示

* 后端 -> 前端
    
    将排序后的搜索结果用Json格式发送到前端

    ```
    {   
        'message_type': 'result',
        'result_timestamp': result_timestamp,
        'paper_info': [paper_0, paper_1, ...],
        'clue_info': [...]
    }
    ```

    > ```result_timestamp``` 可用于拼接结果文件的下载地址，结果文件存放于 ```/static/search_result/result_timestamp/``` 

    > 其中 ```paper_0```、```paper_1``` 均为json，其键值请参考 ```paper_info.xlsx```
